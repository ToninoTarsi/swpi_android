

<!DOCTYPE html>
<head>
    <title>Sint Wind PI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8">
   
	  <link rel="apple-touch-icon" href="icons/icon_iphone_x1.png" />
	  <link rel="apple-touch-icon" sizes="72x72" href="icons/icon_ipad_x2.png" />
	  <link rel="apple-touch-icon" sizes="114x114" href="icons/icon_iphone_x2.png" />
	  <link rel="apple-touch-icon" sizes="144x144" href="icons/icon_ipad_x2.png" />
  
	 <link rel="stylesheet" href="js/jquery.mobile-1.3.1.min.css" />
	<script src="js/jquery-1.10.0.min.js"></script>
     <script src="js/jquery.mobile-1.3.1.min.js"></script>
 
	
	<script type="text/javascript" src="js/tween-min.js"></script>
	<script type="text/javascript" src="js/mysteelseries-0.11.14.js"></script>
<style>

 #canvasLedUpdate {
  position: absolute;
  top: 5px;
  right:10px;;
}  	
</style>

</head>

<script type="text/javascript">

var data;
var ledUpdate;


function UpdateTime()
{
	
	//alert("pp");
	
	if ( data.last_measure_time != null ) {
		
		var dif = getLastMeasureDelay(data.last_measure_time);
		
		if ( dif > 900 ) {
			ledUpdate.setLedColor(steelseries.LedColor.RED_LED);
			ledUpdate.setLedOnOff(true);
			ledUpdate.blink(false);
		}
		else {
			ledUpdate.setLedColor(steelseries.LedColor.GREEN_LED);
			ledUpdate.setLedOnOff(true);
			ledUpdate.blink(false);
		}
		
		document.getElementById('last_measure_time').innerHTML =lastUpdate(data.last_measure_time)

	}
}
	
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}
	
function UpdateData(json){

	//alert("main");

	data = jQuery.parseJSON(json);
	Update(data)

	//alert("Updated");
 
}	
	
function init() {
	

	ledUpdate = new steelseries.Led('canvasLedUpdate', {
        width: 40,
        height: 40,
        ledColor:steelseries.LedColor.BLUE_LED
        });  
	
	setInterval(function(){UpdateTime()},1000);
	
	if ( getParameterByName("android") == "" ) {	
		//alert('Reading meteo');		
		setInterval(function(){UpdateGauge()()},10000);
		UpdateGauge();
	}
	
}
	
 function lastUpdate(updatedata) {   
	//funzione che calcola la differenza dall'ultimo aggiornamento dei dati da last_measure_time
	//ottieni ora corrente
	var myDate = new Date();
	var year = myDate.getFullYear();
	var month = myDate.getMonth();
	if(month <= 9)
		month = '0'+(month+1);
	var day= myDate.getDate();
	if(day <= 9)
		day = '0'+day;
		var hour= myDate.getHours();
	if(hour<= 9)
		hour = '0'+hour;
	var minutes= myDate.getMinutes();
	if(minutes<= 9)
		minutes = '0'+minutes;
	var seconds= myDate.getSeconds();
	if(seconds<= 9)
		seconds = '0'+seconds;
	//var prettyDate = day +'/'+ month +'/'+ year +'-'+ hour +':'+ minutes +':'+ seconds;
	//scrivi ora corrente
	//document.write(prettyDate);


	//converto ultimo aggiornamento in data

	//var str="[02/04/2013-17:20:17]";
	var str=updatedata;
	var n=str.slice(1,20);

	var n=n.split("-");
	var daysplit=n[0].split("/");
	var datesplit=n[1].split(":");

	var day1=daysplit[0];
	var month1=daysplit[1];
	var year1=daysplit[2];


	var hour1=datesplit[0];
	var minutes1=datesplit[1];
	var seconds1=datesplit[2];

	//calcola la differenza

	var date1 = new Date(year1, month1, day1,  hour1, minutes1, seconds1); // ora di lettura
	var date2 = new Date(year, month, day, hour, minutes, seconds); // ora attuale
	if (date2 < date1) {
		date2.setDate(date2.getDate() + 1);
	}
	var diff = date2 - date1;

	var msec = diff;
	var hh = Math.floor(msec / 1000 / 60 / 60);
	msec -= hh * 1000 * 60 * 60;
	var mm = Math.floor(msec / 1000 / 60);
	msec -= mm * 1000 * 60;
	var ss = Math.floor(msec / 1000);
	msec -= ss * 1000;

	//scrivi il risultato
	var result ="";
	//result += "ultima misura: ";
	if(hh != 0) {
		result += hh;
		result += "h, ";
		}
		
	if(mm != 0) {
		result +=  mm;
		result +=  "m e ";
		}
	result += ss;
	result += "s fa";

	return result;

  }  	
	
 function getLastMeasureDelay(updatedata)
 {
 	//funzione che calcola la differenza dall'ultimo aggiornamento dei dati da last_measure_time
 	//in secondi
 	var myDate = new Date();
 	var year = myDate.getFullYear();
 	var month = myDate.getMonth();
 	if(month <= 9)
 		month = '0'+(month+1);
 	var day= myDate.getDate();
 	if(day <= 9)
 		day = '0'+day;
 		var hour= myDate.getHours();
 	if(hour<= 9)
 		hour = '0'+hour;
 	var minutes= myDate.getMinutes();
 	if(minutes<= 9)
 		minutes = '0'+minutes;
 	var seconds= myDate.getSeconds();
 	if(seconds<= 9)
 		seconds = '0'+seconds;
 	//var prettyDate = day +'/'+ month +'/'+ year +'-'+ hour +':'+ minutes +':'+ seconds;
 	//scrivi ora corrente
 	//document.write(prettyDate);


 	//converto ultimo aggiornamento in data

 	//var str="[02/04/2013-17:20:17]";
 	var str=updatedata;
 	var n=str.slice(1,20);

 	var n=n.split("-");
 	var daysplit=n[0].split("/");
 	var datesplit=n[1].split(":");

 	var day1=daysplit[0];
 	var month1=daysplit[1];
 	var year1=daysplit[2];


 	var hour1=datesplit[0];
 	var minutes1=datesplit[1];
 	var seconds1=datesplit[2];

 	//calcola la differenza

 	var date1 = new Date(year1, month1, day1,  hour1, minutes1, seconds1); // ora di lettura
 	var date2 = new Date(year, month, day, hour, minutes, seconds); // ora attuale
 	if (date2 < date1) {
 		date2.setDate(date2.getDate() + 1);
 	}
 	var diff = date2 - date1;
 	
 	return (diff/1000);
 	//alert(diff);
 }

 
function Update(data) {
	
	ledUpdate.setLedColor(steelseries.LedColor.BLUE_LED);
	
	document.getElementById('lblTitle').innerHTML = data.station_name;
	document.getElementById('lblUnits1').innerHTML = data.wind_speed_units;
	document.getElementById('lblUnits2').innerHTML = data.wind_speed_units;

	document.getElementById('wind_ave').innerHTML =	Math.round(data.wind_ave);
	document.getElementById('wind_gust').innerHTML =	Math.round(data.wind_gust);
	document.getElementById('wind_dir').innerHTML =	(data.wind_dir_code);
	
	
	document.getElementById("up-down").src="image/UpDown1Yellow.png";
	if ( data.wind_trend > data.wind_trend_limit )
		document.getElementById("up-down").src="image/arrow_up_red.png";
	if ( data.wind_trend < - (data.wind_trend_limit) )
		document.getElementById("up-down").src="image/Button-Download-icon.png";

	if ( data.wind_trend > 0)
	{
		document.getElementById('wind_trend').innerHTML = '+ ' + Math.round(data.wind_trend);
	}
	else
	{
		document.getElementById('wind_trend').innerHTML = '- ' + Math.abs(Math.round(data.wind_trend));
	}
	
	document.getElementById('temp_out').innerHTML =	Math.round(data.temp_out);
	document.getElementById('pressure').innerHTML =	Math.round(data.rel_pressure);
	document.getElementById('umidity').innerHTML =	Math.round(data.hum_out);

	if ( data.rain_rate != null )
		document.getElementById('rain_rate').innerHTML =  Math.round((data.rain_rate * 10 )) / 10 ;
	else
		document.getElementById('rain_rate').innerHTML = '-';
	
	document.getElementById('coudbase').innerHTML = Math.round(data.cloud_base_altitude);
	
}

function UpdateGauge(){
	  //alert("Updating");
      $.getJSON(
         './meteo.txt',
         function(data1){
        	 data = data1
        	 Update(data1)
				//alert("Updated");
         }
      );
   }	
		
	
</script>



<body onload="init()">
  <div data-role="page" data-theme="a">
    <div data-role="header" style="height:0px">
      <h1><label id="lblTitle">Sint Wind PI</label></h1>
    </div>
    <div data-role="content">

    <ul data-role="listview" data-inset="true" data-divider-theme="b">
		<li data-role="list-divider"> <span style="font-size:200%"> <label  id="last_measure_time">time</label></span> 	<canvas  id="canvasLedUpdate" width="40" height="40"></canvas> </li>
		<li> <img src="image/Wind-Flag-Storm-icon.png"> <span style="font-size:150%"> <label id="wind_dir">dir</label> <br> <label id="wind_ave"></label>(<label id="wind_gust">gust</label>)  </span> <label id="lblUnits1">units</label> </li>
		<li> <img src="image/UpDown1Yellow.png" id="up-down" >  <span style="font-size:150%">  <label id="wind_trend">trend</label> </span> <label id="lblUnits2">kmh</label>/h </li>		
        <li> <img src="image/thermometer.png"  >  <span style="font-size:150%">  <label id="temp_out">temp</label> </span>Â°C </li>
		<li> <img src="image/blood-pressure-icon.png"  >    <span style="font-size:150%">  <label id="pressure">pres</label> </span> hPa</li>
		<li> <img src="image/water-icon.png"  >  <span style="font-size:150%">  <label id="umidity">hum</label> </span>  %</li>
		<li> <img src="image/Status-weather-many-clouds-icon.png"  >  <span style="font-size:150%">  <label id="coudbase">cb</label> </span> meters   </li>		
        <li> <img src="image/rain-icon.png"  >  <span style="font-size:150%">  <label id="rain_rate">rain</label> </span>  mm </li>		      
	</ul>
		
 </div>
    <div data-role="footer">
      <h4>Powered by Sint Wind Pi</h4>
    </div>
  </div> 
</body>






</html>
